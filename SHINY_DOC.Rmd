---
title: "API_IUCN_ELEVATION"
author: "James Lee"
date: "11/06/2021"
output:
  html_document: default
  pdf_document: default
---

##Relevant libraries

```{r message=FALSE, warning=FALSE}
suppressMessages(library(utils))
suppressMessages(library(rredlist))
suppressMessages(library(tidyverse))
suppressMessages(library(rlist))
suppressMessages(library(reshape2))
suppressMessages(library(ggplot2))
suppressMessages(library(Rmisc))
suppressMessages(library(dplyr))
suppressMessages(library(plotly))
```

##IUCN api-key

```{r}
Sys.setenv(IUCN_KEY = 'fcf03dabdd0e2353081b6eac1a965078748e52b345f661492a2aff580d58f3a9')
Sys.getenv("IUCN_KEY") # hides IUCN API key in R environment
apikey <- Sys.getenv("IUCN_KEY")
#Gorilla test
test = rl_search('Gorilla gorilla', key = apikey) # rl_search is a function which allows us to search at a species by species basis
test$result # should print a data-frame of Gorrila gorilla with preliminary information
```

##Malaysian species

We aim to obtain vulnerable/endangered species from tropical montane regions with a minimum lower elevation limit of 1000m. As this is only a test example we will only obtain species found in Malaysia initially.

Luckily for us the IUCN API has information about all of this and it is easily requested. As for the specific requests themselves it will depend on what sort of information we seek to query. Some require multiple queries and so take much longer to obtain data for. 

```{r}
out <- rl_sp_country(country = 'MY', key = apikey) # rl_search by country so all species in that country contained in the API can be obtained
# in this case the search country is malaysia isocode is MY
all_df <- out$result # obtain results only

example = all_df %>%
  select(scientific_name, category) #just to filter out to necessary information on whether the species is endandgered

head(example) #to give only the first six rows of the data frame
```

###Data cleaning

Now we have one aspect of the data we need, we still need the elevation lower limit and the habitat data. To do this we just need to call the list of species through another query and obtain the relevant data to filter it effectively.

```{r}
#Sort the data so we only get the vulnerability categorys we need
Endangered_list <- all_df %>% 
  filter(category == c('CR','EN', 'VU', 'LR')) %>%  # all the codes for vulnerable to near extinction
  mutate(iucn_pull = map(scientific_name, rl_habitats, key = apikey)) # adds another list of dataframes containing information about habitats
```

For practicality we cannot print this dataframe (Endangered_list) because it is too big. We also split the function into two separate parts. The first part of cleaning was the code snippet above which keeps all the species which are considered to be 'endangered'. 

```{r}
api_clean <- Endangered_list %>% 
  mutate(habitat = map(iucn_pull, pluck, "result", "habitat")) %>% #pull habitat data from dataframe
  select(scientific_name, habitat) %>% # take the species name column and the habitat column
  mutate(BOOLEAN = map(habitat, `%in%`, x = 'Forest - Subtropical/Tropical Moist Montane')) %>% #make a new column which tests whether the species is found in our chosen habitat
  filter(BOOLEAN == 'TRUE') %>%
  select(scientific_name) %>%
  mutate(iucn_pull_2 = map(scientific_name, rl_search, key = apikey)) %>% # obtain narrative information
  mutate(elevation_lower = as.numeric(map(iucn_pull_2, pluck, "result", "elevation_lower"))) %>% # pluck elevation data 
  mutate(category = as.character(map(iucn_pull_2, pluck, "result", "category"))) %>% 
  select(scientific_name, elevation_lower, category) %>%
  filter(elevation_lower > 1000)

api_clean # cleaned data frame with all the species that meet our criteria
```

###Analysis step

Now let's look at some analysis. Firstly, an analysis of Variance.

```{r}
model_1 = aov(elevation_lower~category, data = api_clean)

shapiro.test(resid(aov(elevation_lower~category, data = api_clean)))

#residuals are not normally distributed

model_2 = kruskal.test(elevation_lower~category, data = api_clean)

model_2
```

Our analysis shows us that there is no detectable difference in lower elevation limit when comparing between species of varying vulnerabilites.

Now let's plot it...

```{r}
tgc <- summarySE(api_clean, measurevar="elevation_lower", groupvars="category")

plot_1 = ggplot(api_clean, aes(x = category, y = elevation_lower, fill = category, label = scientific_name)) + 
  geom_jitter(width = 0.1) +
  geom_boxplot() + 
  scale_fill_discrete(labels = c("Critically Endangered", "Endagered", "Vulnerable")) + 
  scale_y_continuous(limits = c(0,3500), expand = c(0,NA)) +
  labs(y = "Lower elevation /m", x = " ", fill = "IUCN category") + 
  theme_bw()

ggplotly(plot_1)
```

